server {
    listen 80;
    listen [::]:80;
	server_name ${DOMAIN_NAME};
    # redirtion to https
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    listen [::]:443 ssl;

    server_name ${DOMAIN_NAME};
    root /var/www/wordpress;
    index index.php index.html index.htm;
        
    # SSL 配置
    ssl_certificate /etc/nginx/ssl/localhost.crt;
    ssl_certificate_key /etc/nginx/ssl/localhost.key;
    ssl_protocols TLSv1.2 TLSv1.3;

    # 1. 根路径 Location 块：处理非PHP文件的访问和URL重写
    location / {
        # 如果文件或目录存在则直接访问，否则重写到 index.php
        try_files $uri $uri/ /index.php?$args; 
    }

    # 2. PHP FastCGI Location 块：处理所有 PHP 文件请求
    location ~ [^/]\.php(/|$) {  
        # 确保 PHP-FPM 知道根路径
        root /var/www/wordpress; 
            
        # ❗ 关键：代理到 WordPress 容器的 9000 端口
        fastcgi_pass wordpress:9000;

        # 包含 FastCGI 核心参数
        include fastcgi_params; 
            
        # ❗ 关键：设置 PHP 脚本的绝对路径
        # fastcgi_script_name 是 URL 中的 PHP 文件名
        # $document_root 应该指向 /var/www/wordpress
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;

        # 传递 HTTPS 变量给 WordPress，避免重定向循环
        fastcgi_param HTTPS on; 
            
        # 提高超时时间以防止长脚本执行导致 502
        fastcgi_read_timeout 300;
        }

    # 可选：拒绝访问 .htaccess 文件
    location ~ /\.ht {
        deny all;
    }
}


# user  root;
# worker_processes  1;

# events {
#     worker_connections 1024;
# }

# http {
#     include       /etc/nginx/mime.types;
#     default_type  application/octet-stream;

#     sendfile        on;
#     keepalive_timeout 65;

#     server {
#         listen 443 ssl;
#         listen [::]:443 ssl;

#         server_name jinhuang.42.fr;

#         ssl_certificate /etc/nginx/ssl/localhost.crt;
#         ssl_certificate_key /etc/nginx/ssl/localhost.key;

#         ssl_protocols TLSv1.2 TLSv1.3;

#         root /var/www/wordpress; 
#         index index.php index.html index.htm;

#         location / {
#             try_files $uri $uri/ /index.php$is_args$args;
#         }
#         # /etc/nginx/conf.d/default.conf

#         location ~ \.php$ {
#             # 保持 root 的明确定义
#             root /var/www/wordpress; 

#             fastcgi_split_path_info ^(.+\.php)(/.+)$;
#             fastcgi_pass wordpress:9000;
#             fastcgi_index index.php;

#             # ⚠️ 关键修改 A：使用 fastcgi.conf (如果可用，它比 fastcgi_params 更全面)
#             # 如果您的 Nginx 镜像中只有 fastcgi_params，请使用下一个步骤
#             # include fastcgi.conf; 

#             # ⚠️ 关键修改 B：如果只有 fastcgi_params，则将其放在 SCRIPT_FILENAME 之前
#             include fastcgi_params;

#             # 确保 SCRIPT_FILENAME 传递绝对路径
#             fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;

#             # ⚠️ 关键修改 C：由于您使用 SSL，手动传递 HTTPS 变量
#             fastcgi_param HTTPS on; 
#         }
#     }
# }


